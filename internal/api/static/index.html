<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ClaudeGate — API Playground</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d1117;--surface:#161b22;--border:#30363d;
  --text:#e6edf3;--muted:#8b949e;
  --accent:#58a6ff;--success:#3fb950;--error:#f85149;--warning:#d29922;
  --tag-get:#238636;--tag-post:#1f6feb;--tag-delete:#da3633;
  --radius:6px;--font-mono:'SFMono-Regular',Consolas,'Liberation Mono',Menlo,monospace;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;font-size:14px;line-height:1.5}
a{color:var(--accent);text-decoration:none}
button{cursor:pointer;border:none;border-radius:var(--radius);font-size:13px;font-family:inherit;transition:opacity .15s,background .15s}
button:hover{opacity:.85}
input,select,textarea{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:13px;padding:6px 10px;width:100%;outline:none;transition:border-color .15s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;line-height:1.5}
select option{background:var(--surface)}

/* Layout */
.app{display:flex;flex-direction:column;min-height:100vh}
.header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.header h1{font-size:15px;font-weight:600;white-space:nowrap}
.header h1 span{color:var(--muted);font-weight:400}
.apikey-bar{display:flex;align-items:center;gap:8px;flex:1;min-width:200px;max-width:500px}
.apikey-bar label{white-space:nowrap;color:var(--muted);font-size:12px}
.apikey-wrap{position:relative;flex:1}
.apikey-wrap input{padding-right:34px}
.apikey-toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);padding:0;font-size:14px;line-height:1}
.apikey-toggle:hover{color:var(--text);opacity:1}
.btn-save{background:var(--accent);color:#fff;padding:6px 14px;white-space:nowrap}
.key-status{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;transition:background .3s}
.key-status.valid{background:var(--success)}
.key-status.invalid{background:var(--error)}

.main{display:flex;flex:1;overflow:hidden}
.panel-left{width:50%;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;flex-shrink:0}
.panel-right{flex:1;overflow-y:auto;padding:16px;min-width:0}
.splitter{width:4px;background:var(--border);cursor:col-resize;flex-shrink:0;transition:background .15s;user-select:none}
.splitter:hover,.splitter.active{background:rgba(88,166,255,.5)}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.card-title{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px}

/* Playground */
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:12px;color:var(--muted)}
.system-toggle{background:none;color:var(--accent);font-size:12px;padding:0;text-align:left;display:flex;align-items:center;gap:4px}
.system-toggle:hover{opacity:.8}
.collapsed{display:none}
.row{display:flex;gap:8px;align-items:flex-end}
.row .field{flex:1}
.btn-send{background:var(--accent);color:#fff;padding:8px 20px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px;white-space:nowrap}
.btn-send:disabled{opacity:.5;cursor:not-allowed}

/* Status badge */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:500}
.badge-queued{background:rgba(210,153,34,.15);color:var(--warning)}
.badge-processing{background:rgba(88,166,255,.15);color:var(--accent)}
.badge-completed{background:rgba(63,185,80,.15);color:var(--success)}
.badge-failed{background:rgba(248,81,73,.15);color:var(--error)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.badge-processing{animation:pulse 1.5s ease-in-out infinite}

/* Response area */
.response-box{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:12px;font-family:var(--font-mono);font-size:13px;min-height:140px;max-height:320px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;line-height:1.6}
.response-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.response-empty{color:var(--muted);font-style:italic;font-family:inherit}

/* Job history */
.job-list{display:flex;flex-direction:column;gap:6px}
.job-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:border-color .15s}
.job-item:hover{border-color:var(--accent)}
.job-id{font-family:var(--font-mono);font-size:12px;color:var(--accent);flex-shrink:0}
.job-model{font-size:11px;color:var(--muted);flex-shrink:0}
.job-time{font-size:11px;color:var(--muted);margin-left:auto;flex-shrink:0}
.btn-delete{background:none;color:var(--muted);padding:2px 5px;font-size:13px;flex-shrink:0;border-radius:3px}
.btn-delete:hover{color:var(--error);background:rgba(248,81,73,.1);opacity:1}
.job-list-empty{color:var(--muted);font-size:12px;font-style:italic}
.btn-refresh{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 10px;font-size:12px;border-radius:var(--radius)}
.btn-refresh:hover{border-color:var(--accent);color:var(--accent);opacity:1}
.history-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}

/* API Docs */
.endpoint{border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;overflow:hidden}
.endpoint-head{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;background:var(--bg);user-select:none;transition:background .15s}
.endpoint-head:hover{background:#1c2128}
.method{font-family:var(--font-mono);font-size:11px;font-weight:700;padding:2px 7px;border-radius:3px;flex-shrink:0}
.method-get{background:rgba(35,134,54,.2);color:#3fb950}
.method-post{background:rgba(31,111,235,.2);color:#58a6ff}
.method-delete{background:rgba(218,51,51,.2);color:#f85149}
.path{font-family:var(--font-mono);font-size:13px;flex:1}
.chevron{color:var(--muted);font-size:11px;transition:transform .2s;flex-shrink:0}
.endpoint-body{padding:12px;border-top:1px solid var(--border);display:none;flex-direction:column;gap:10px}
.endpoint-body.open{display:flex}
.endpoint-desc{font-size:13px;color:var(--muted)}
.code-block{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;font-family:var(--font-mono);font-size:12px;overflow-x:auto;white-space:pre;position:relative}
.code-label{font-size:11px;color:var(--muted);font-weight:600;margin-bottom:4px;text-transform:uppercase}
.btn-copy{position:absolute;top:6px;right:6px;background:var(--surface);border:1px solid var(--border);color:var(--muted);padding:2px 8px;font-size:11px;border-radius:3px}
.btn-copy:hover{color:var(--text);opacity:1}
.json-key{color:#79c0ff}
.json-str{color:#a5d6ff}
.json-num{color:#79c0ff}
.json-bool{color:#ff7b72}
.json-null{color:#ff7b72}

/* Try it */
.tryit-section{border-top:1px solid var(--border);padding-top:10px;display:flex;flex-direction:column;gap:8px}
.tryit-label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px}
.tryit-fields{display:flex;flex-direction:column;gap:6px}
.tryit-field{display:flex;flex-direction:column;gap:3px}
.tryit-field label{font-size:12px;color:var(--muted)}
.tryit-row{display:flex;gap:8px;align-items:flex-end}
.tryit-row .tryit-field{flex:1}
.tryit-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn-tryit{background:var(--accent);color:#fff;padding:6px 14px;font-size:12px;font-weight:500;display:flex;align-items:center;gap:5px;white-space:nowrap}
.btn-tryit:disabled{opacity:.5;cursor:not-allowed}
.btn-cancel-sse{background:none;border:1px solid var(--error);color:var(--error);padding:5px 12px;font-size:12px;border-radius:var(--radius)}
.btn-cancel-sse:hover{background:rgba(248,81,73,.1);opacity:1}
.btn-use-latest{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;font-size:11px;border-radius:var(--radius);white-space:nowrap}
.btn-use-latest:hover{border-color:var(--accent);color:var(--accent);opacity:1}
.tryit-response{display:none;flex-direction:column;gap:6px}
.tryit-response.visible{display:flex}
.tryit-response-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.http-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;font-family:var(--font-mono)}
.http-badge-2xx{background:rgba(63,185,80,.15);color:var(--success)}
.http-badge-3xx{background:rgba(88,166,255,.15);color:var(--accent)}
.http-badge-4xx{background:rgba(248,81,73,.15);color:var(--error)}
.http-badge-5xx{background:rgba(248,81,73,.15);color:var(--error)}
.tryit-headers{font-family:var(--font-mono);font-size:11px;color:var(--muted);padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius)}
.tryit-body{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;font-family:var(--font-mono);font-size:12px;max-height:240px;overflow-y:auto;white-space:pre-wrap;word-break:break-word;line-height:1.6}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* Responsive */
@media(max-width:700px){
  .main{flex-direction:column}
  .panel-left,.panel-right{width:100%!important}
  .panel-left{border-right:none;border-bottom:1px solid var(--border)}
  .splitter{display:none}
}
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <h1>ClaudeGate <span>— API Playground</span></h1>
    <div class="apikey-bar">
      <label>API Key:</label>
      <div class="apikey-wrap">
        <input type="password" id="apiKeyInput" placeholder="your-api-key" autocomplete="off">
        <button class="apikey-toggle" id="keyToggle" title="Show/hide key">&#128065;</button>
      </div>
      <div class="key-status" id="keyStatus" title="Key status"></div>
      <button class="btn-save" id="btnSave">Save</button>
    </div>
  </div>

  <div class="main">

    <!-- Left panel: Playground + History -->
    <div class="panel-left">

      <!-- Playground card -->
      <div class="card">
        <div class="card-title">Playground</div>

        <div style="display:flex;flex-direction:column;gap:10px">
          <div class="row">
            <div class="field">
              <label>Model</label>
              <select id="modelSelect">
                <option value="haiku">claude-haiku</option>
                <option value="sonnet">claude-sonnet</option>
                <option value="opus">claude-opus</option>
              </select>
            </div>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:pointer;white-space:nowrap">
              <input type="checkbox" id="jsonMode"> JSON mode
            </label>
          </div>

          <div class="field">
            <button class="system-toggle" id="systemToggleBtn">
              <span id="systemChevron">&#9654;</span> System Prompt <span style="color:var(--muted)">(optional)</span>
            </button>
            <textarea id="systemPrompt" class="collapsed" rows="3" placeholder="You are a helpful assistant."></textarea>
          </div>

          <div class="field">
            <label>Prompt <span style="color:var(--error)">*</span></label>
            <textarea id="promptInput" rows="4" placeholder="Ask something..."></textarea>
          </div>

          <div>
            <button class="btn-send" id="btnSend">
              <span>&#9654;</span> Send
            </button>
          </div>

          <!-- Response -->
          <div>
            <div class="response-meta">
              <span style="font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.05em">Response</span>
              <span id="statusBadge"></span>
              <span id="jobIdDisplay" style="font-family:var(--font-mono);font-size:11px;color:var(--muted)"></span>
            </div>
            <div class="response-box" id="responseBox"><span class="response-empty">Response will appear here...</span></div>
          </div>
        </div>
      </div>

      <!-- Job History card -->
      <div class="card">
        <div class="history-header">
          <div class="card-title" style="margin-bottom:0">Job History</div>
          <button class="btn-refresh" id="btnRefresh">&#8635; Refresh</button>
        </div>
        <div class="job-list" id="jobList">
          <div class="job-list-empty">No jobs yet.</div>
        </div>
      </div>

    </div>

    <!-- Draggable splitter -->
    <div class="splitter" id="splitter"></div>

    <!-- Right panel: API Docs -->
    <div class="panel-right">
      <div class="card-title" style="margin-bottom:12px">API Documentation</div>
      <div id="apiDocs"></div>
    </div>

  </div>
</div>

<script>
(function() {
'use strict';

// Base URL: strip trailing slash so relative paths work under any proxy prefix
const base = window.location.pathname.replace(/\/[^/]*$/, '').replace(/\/+$/, '');
const api = (path) => base + '/' + path.replace(/^\//, '');

// ── API Key ──────────────────────────────────────────────────────────────────
const keyInput = document.getElementById('apiKeyInput');
const keyStatus = document.getElementById('keyStatus');
const keyToggle = document.getElementById('keyToggle');
const btnSave = document.getElementById('btnSave');

let apiKey = localStorage.getItem('cg_api_key') || '';
keyInput.value = apiKey;

keyToggle.addEventListener('click', () => {
  const show = keyInput.type === 'password';
  keyInput.type = show ? 'text' : 'password';
  keyToggle.innerHTML = show ? '&#128064;' : '&#128065;';
});

btnSave.addEventListener('click', () => {
  apiKey = keyInput.value.trim();
  localStorage.setItem('cg_api_key', apiKey);
  btnSave.textContent = 'Saved!';
  setTimeout(() => { btnSave.textContent = 'Save'; }, 1500);
  validateKey();
});

keyInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') btnSave.click();
});

async function validateKey() {
  if (!apiKey) { setKeyStatus(null); return; }
  try {
    const r = await fetch(api('api/v1/jobs?limit=1'), {
      headers: { 'X-API-Key': apiKey }
    });
    setKeyStatus(r.ok);
  } catch {
    setKeyStatus(false);
  }
}

function setKeyStatus(valid) {
  keyStatus.className = 'key-status' + (valid === true ? ' valid' : valid === false ? ' invalid' : '');
  keyStatus.title = valid === true ? 'Key valid' : valid === false ? 'Key invalid or server unreachable' : 'Not validated';
}

if (apiKey) validateKey();

// ── Helpers ──────────────────────────────────────────────────────────────────
function authHeaders(extra) {
  return Object.assign({ 'X-API-Key': apiKey }, extra || {});
}

function timeAgo(dateStr) {
  const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
  if (diff < 60) return diff + 's ago';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}

function statusBadgeHTML(status) {
  return `<span class="badge badge-${status}">${status}</span>`;
}

// ── System prompt toggle ─────────────────────────────────────────────────────
const systemToggleBtn = document.getElementById('systemToggleBtn');
const systemPrompt = document.getElementById('systemPrompt');
const systemChevron = document.getElementById('systemChevron');
let systemOpen = false;

systemToggleBtn.addEventListener('click', () => {
  systemOpen = !systemOpen;
  systemPrompt.classList.toggle('collapsed', !systemOpen);
  systemChevron.innerHTML = systemOpen ? '&#9660;' : '&#9654;';
});

// ── Playground ───────────────────────────────────────────────────────────────
const promptInput = document.getElementById('promptInput');
const modelSelect = document.getElementById('modelSelect');
const btnSend = document.getElementById('btnSend');
const responseBox = document.getElementById('responseBox');
const statusBadgeEl = document.getElementById('statusBadge');
const jobIdDisplay = document.getElementById('jobIdDisplay');

let activeSSE = null;

btnSend.addEventListener('click', sendJob);

async function sendJob() {
  const prompt = promptInput.value.trim();
  if (!prompt) { promptInput.focus(); return; }
  if (!apiKey) { alert('Please enter and save your API key first.'); return; }

  if (activeSSE) { activeSSE.close(); activeSSE = null; }

  btnSend.disabled = true;
  responseBox.innerHTML = '';
  statusBadgeEl.innerHTML = statusBadgeHTML('queued');
  jobIdDisplay.textContent = '';

  const body = { prompt, model: modelSelect.value };
  const sp = systemPrompt.value.trim();
  if (sp) body.system_prompt = sp;
  if (document.getElementById('jsonMode').checked) body.response_format = 'json';

  let jobId;
  try {
    const r = await fetch(api('api/v1/jobs'), {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(body)
    });
    if (!r.ok) {
      const err = await r.json().catch(() => ({ error: r.statusText }));
      showError('Failed to create job: ' + (err.error || r.statusText));
      btnSend.disabled = false;
      return;
    }
    const job = await r.json();
    jobId = job.job_id;
    jobIdDisplay.textContent = '#' + jobId.slice(0, 8);
  } catch (e) {
    showError('Network error: ' + e.message);
    btnSend.disabled = false;
    return;
  }

  // Open SSE stream
  openSSE(jobId);
}

function openSSE(jobId) {
  const url = api('api/v1/jobs/' + jobId + '/sse');
  // EventSource doesn't support custom headers — use fetch with ReadableStream
  const ctrl = new AbortController();
  activeSSE = ctrl;

  fetch(url, { headers: authHeaders(), signal: ctrl.signal })
    .then(r => {
      if (!r.ok) return r.json().then(e => { throw new Error(e.error || r.statusText); });
      const reader = r.body.getReader();
      const decoder = new TextDecoder();
      let buf = '';

      function pump() {
        reader.read().then(({ done, value }) => {
          if (done) { btnSend.disabled = false; loadHistory(); return; }
          buf += decoder.decode(value, { stream: true });
          const parts = buf.split('\n\n');
          buf = parts.pop();
          parts.forEach(parseSSEChunk);
          pump();
        }).catch(e => {
          if (e.name !== 'AbortError') showError('Stream error: ' + e.message);
          btnSend.disabled = false;
          loadHistory();
        });
      }
      pump();
    })
    .catch(e => {
      if (e.name !== 'AbortError') showError('SSE error: ' + e.message);
      btnSend.disabled = false;
    });
}

function parseSSEChunk(raw) {
  const lines = raw.split('\n');
  let eventName = '', dataStr = '';
  for (const line of lines) {
    if (line.startsWith('event: ')) eventName = line.slice(7).trim();
    else if (line.startsWith('data: ')) dataStr = line.slice(6).trim();
  }
  if (!dataStr) return;
  let data;
  try { data = JSON.parse(dataStr); } catch { return; }

  if (eventName === 'status') {
    statusBadgeEl.innerHTML = statusBadgeHTML(data.status || 'queued');
  } else if (eventName === 'chunk') {
    const chunk = data.chunk || data.text || data;
    if (typeof chunk === 'string') {
      if (!responseBox.dataset.streaming) {
        responseBox.textContent = '';
        responseBox.dataset.streaming = '1';
      }
      responseBox.textContent += chunk;
      responseBox.scrollTop = responseBox.scrollHeight;
    }
  } else if (eventName === 'result') {
    delete responseBox.dataset.streaming;
    statusBadgeEl.innerHTML = statusBadgeHTML(data.status || 'completed');
    if (data.result) {
      if (document.getElementById('jsonMode').checked) {
        try {
          responseBox.textContent = JSON.stringify(JSON.parse(data.result), null, 2);
        } catch {
          responseBox.textContent = data.result;
        }
      } else {
        responseBox.textContent = data.result;
      }
    } else if (data.error) {
      responseBox.textContent = 'Error: ' + data.error;
    }
    responseBox.scrollTop = responseBox.scrollHeight;
    btnSend.disabled = false;
    if (activeSSE) { activeSSE.abort(); activeSSE = null; }
    loadHistory();
  }
}

function showError(msg) {
  statusBadgeEl.innerHTML = statusBadgeHTML('failed');
  responseBox.textContent = msg;
}

function showJobResult(job) {
  jobIdDisplay.textContent = '#' + job.job_id.slice(0, 8);
  statusBadgeEl.innerHTML = statusBadgeHTML(job.status);
  if (job.result) {
    responseBox.textContent = job.result;
  } else if (job.error) {
    responseBox.textContent = 'Error: ' + job.error;
  } else {
    responseBox.textContent = job.status === 'queued' ? 'Job is queued...' : 'Processing...';
  }
}

// ── Job History ───────────────────────────────────────────────────────────────
const jobList = document.getElementById('jobList');
const btnRefresh = document.getElementById('btnRefresh');

btnRefresh.addEventListener('click', loadHistory);

async function loadHistory() {
  try {
    const r = await fetch(api('api/v1/jobs?limit=10'), { headers: authHeaders() });
    if (!r.ok) return;
    const data = await r.json();
    renderHistory(data.jobs || []);
    setKeyStatus(true);
  } catch (e) {
    console.error('Failed to load history:', e);
  }
}

function renderHistory(jobs) {
  if (!jobs.length) {
    jobList.innerHTML = '<div class="job-list-empty">No jobs yet.</div>';
    return;
  }
  jobList.innerHTML = '';
  jobs.forEach(job => {
    const item = document.createElement('div');
    item.className = 'job-item';
    item.innerHTML =
      `<span class="job-id">#${job.job_id.slice(0,8)}</span>` +
      `<span class="job-model">${job.model}</span>` +
      statusBadgeHTML(job.status) +
      `<span class="job-time">${timeAgo(job.created_at)}</span>` +
      `<button class="btn-delete" data-id="${job.job_id}" title="Delete job">&#128465;</button>`;
    item.querySelector('.btn-delete').addEventListener('click', async (e) => {
      e.stopPropagation();
      await deleteJob(job.job_id);
    });
    item.addEventListener('click', () => showJobResult(job));
    jobList.appendChild(item);
  });
}

async function deleteJob(id) {
  try {
    await fetch(api('api/v1/jobs/' + id), {
      method: 'DELETE',
      headers: authHeaders()
    });
  } catch (e) {
    console.error('Failed to delete job:', e);
  }
  loadHistory();
}

// ── API Documentation ─────────────────────────────────────────────────────────
const endpoints = [
  {
    method: 'POST', path: '/api/v1/jobs',
    desc: 'Submit a new job. Returns 202 Accepted with the created job object.',
    curl: `curl -X POST https://example.com/api/v1/jobs \\
  -H "X-API-Key: your-key" \\
  -H "Content-Type: application/json" \\
  -d '{"prompt": "Explain what a mutex is.", "model": "haiku", "system_prompt": "Be concise.", "response_format": "json"}'`,
    response: `{
  "job_id": "a1b2c3d4-e5f6-...",
  "prompt": "Explain what a mutex is.",
  "model": "haiku",
  "status": "queued",
  "created_at": "2025-01-01T00:00:00Z"
}`,
    tryit: { type: 'post-job' }
  },
  {
    method: 'GET', path: '/api/v1/jobs',
    desc: 'List jobs with pagination. Query params: limit (default 20), offset (default 0).',
    curl: `curl "https://example.com/api/v1/jobs?limit=10&offset=0" \\
  -H "X-API-Key: your-key"`,
    response: `{
  "jobs": [ { "job_id": "...", "status": "completed", ... } ],
  "total": 42,
  "limit": 10,
  "offset": 0
}`,
    tryit: { type: 'list-jobs' }
  },
  {
    method: 'GET', path: '/api/v1/jobs/{id}',
    desc: 'Poll a job\'s status and result.',
    curl: `curl "https://example.com/api/v1/jobs/a1b2c3d4-..." \\
  -H "X-API-Key: your-key"`,
    response: `{
  "job_id": "a1b2c3d4-...",
  "model": "haiku",
  "status": "completed",
  "result": "A mutex ensures exclusive access to a shared resource.",
  "created_at": "2025-01-01T00:00:00Z",
  "started_at": "2025-01-01T00:00:00.1Z",
  "completed_at": "2025-01-01T00:00:02Z"
}`,
    tryit: { type: 'get-job' }
  },
  {
    method: 'GET', path: '/api/v1/jobs/{id}/sse',
    desc: 'Stream job progress via Server-Sent Events. Events: status, chunk, result. Connection closes when job finishes.',
    curl: `curl -N "https://example.com/api/v1/jobs/a1b2c3d4-.../sse" \\
  -H "X-API-Key: your-key"`,
    response: `event: status
data: {"job_id":"...","status":"processing"}

event: chunk
data: {"text":"A mutex "}

event: result
data: {"job_id":"...","status":"completed","result":"A mutex..."}`,
    tryit: { type: 'sse-job' }
  },
  {
    method: 'DELETE', path: '/api/v1/jobs/{id}',
    desc: 'Delete a job record. Returns 204 No Content.',
    curl: `curl -X DELETE "https://example.com/api/v1/jobs/a1b2c3d4-..." \\
  -H "X-API-Key: your-key"`,
    response: `HTTP/1.1 204 No Content`,
    tryit: { type: 'delete-job' }
  },
  {
    method: 'GET', path: '/api/v1/health',
    desc: 'Health check. No authentication required.',
    curl: `curl "https://example.com/api/v1/health"`,
    response: `{"status": "ok"}`,
    tryit: { type: 'health' }
  }
];

function highlightJSON(str) {
  return str
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/("(?:[^"\\]|\\.)*")\s*:/g, '<span class="json-key">$1</span>:')
    .replace(/:\s*("(?:[^"\\]|\\.)*")/g, ': <span class="json-str">$1</span>')
    .replace(/:\s*(-?\d+(?:\.\d+)?)/g, ': <span class="json-num">$1</span>')
    .replace(/:\s*(true|false)/g, ': <span class="json-bool">$1</span>')
    .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
}

function buildTryitHTML(ep, i) {
  const t = ep.tryit.type;
  var fields = '';

  if (t === 'post-job') {
    fields =
      '<div class="tryit-field">' +
        '<label>prompt <span style="color:var(--error)">*</span></label>' +
        '<textarea id="ti-'+i+'-prompt" rows="3" placeholder="Ask something..."></textarea>' +
      '</div>' +
      '<div class="tryit-row">' +
        '<div class="tryit-field">' +
          '<label>model</label>' +
          '<select id="ti-'+i+'-model">' +
            '<option value="haiku">claude-haiku</option>' +
            '<option value="sonnet">claude-sonnet</option>' +
            '<option value="opus">claude-opus</option>' +
          '</select>' +
        '</div>' +
        '<div class="tryit-field">' +
          '<label>system_prompt</label>' +
          '<input type="text" id="ti-'+i+'-system" placeholder="optional">' +
        '</div>' +
        '<label style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--muted);cursor:pointer;white-space:nowrap;padding-bottom:7px">' +
          '<input type="checkbox" id="ti-'+i+'-json"> JSON mode' +
        '</label>' +
      '</div>';
  } else if (t === 'list-jobs') {
    fields =
      '<div class="tryit-row">' +
        '<div class="tryit-field">' +
          '<label>limit</label>' +
          '<input type="number" id="ti-'+i+'-limit" value="20" min="1" max="100">' +
        '</div>' +
        '<div class="tryit-field">' +
          '<label>offset</label>' +
          '<input type="number" id="ti-'+i+'-offset" value="0" min="0">' +
        '</div>' +
      '</div>';
  } else if (t === 'get-job' || t === 'sse-job' || t === 'delete-job') {
    fields =
      '<div class="tryit-field">' +
        '<label>job_id</label>' +
        '<div style="display:flex;gap:6px">' +
          '<input type="text" id="ti-'+i+'-jobid" placeholder="a1b2c3d4-e5f6-..." style="flex:1">' +
          '<button class="btn-use-latest" id="ti-'+i+'-latest">Use latest</button>' +
        '</div>' +
      '</div>';
  }

  var cancelBtn = t === 'sse-job' ? '<button class="btn-cancel-sse" id="ti-'+i+'-cancel" style="display:none">&#9632; Cancel</button>' : '';

  return '<div class="tryit-section">' +
    '<div class="tryit-label">Try it</div>' +
    (fields ? '<div class="tryit-fields">' + fields + '</div>' : '') +
    '<div class="tryit-actions">' +
      '<button class="btn-tryit" id="ti-'+i+'-btn">&#9654; Send Request</button>' +
      cancelBtn +
    '</div>' +
    '<div class="tryit-response" id="ti-'+i+'-resp">' +
      '<div class="tryit-response-meta">' +
        '<span id="ti-'+i+'-status-badge"></span>' +
        '<div class="tryit-headers" id="ti-'+i+'-headers" style="display:none"></div>' +
      '</div>' +
      '<div class="tryit-body" id="ti-'+i+'-body"></div>' +
    '</div>' +
  '</div>';
}

function getLatestJobId() {
  const btn = jobList.querySelector('.job-item .btn-delete');
  return btn ? btn.dataset.id : '';
}

function httpBadgeHTML(status) {
  var cls = 'http-badge-5xx';
  if (status >= 200 && status < 300) cls = 'http-badge-2xx';
  else if (status >= 300 && status < 400) cls = 'http-badge-3xx';
  else if (status >= 400 && status < 500) cls = 'http-badge-4xx';
  return '<span class="http-badge ' + cls + '">HTTP ' + status + '</span>';
}

function showTryitResponse(i, statusCode, headersText, bodyHTML) {
  var resp = document.getElementById('ti-'+i+'-resp');
  var badge = document.getElementById('ti-'+i+'-status-badge');
  var headersEl = document.getElementById('ti-'+i+'-headers');
  var bodyEl = document.getElementById('ti-'+i+'-body');
  badge.innerHTML = httpBadgeHTML(statusCode);
  if (headersText) {
    headersEl.textContent = headersText;
    headersEl.style.display = '';
  } else {
    headersEl.style.display = 'none';
  }
  bodyEl.innerHTML = bodyHTML;
  resp.classList.add('visible');
  bodyEl.scrollTop = 0;
}

function extractHeaders(r) {
  var parts = [];
  var ct = r.headers.get('Content-Type');
  var rid = r.headers.get('X-Request-ID');
  if (ct) parts.push('Content-Type: ' + ct);
  if (rid) parts.push('X-Request-ID: ' + rid);
  return parts.join('\n');
}

function tryitSend(ep, i) {
  const t = ep.tryit.type;
  const btn = document.getElementById('ti-'+i+'-btn');
  const bodyEl = document.getElementById('ti-'+i+'-body');
  const resp = document.getElementById('ti-'+i+'-resp');

  if (!apiKey && t !== 'health') {
    alert('Please enter and save your API key first.');
    return;
  }

  btn.disabled = true;

  if (t === 'post-job') {
    const prompt = document.getElementById('ti-'+i+'-prompt').value.trim();
    if (!prompt) { document.getElementById('ti-'+i+'-prompt').focus(); btn.disabled = false; return; }
    const body = { prompt, model: document.getElementById('ti-'+i+'-model').value };
    const sp = document.getElementById('ti-'+i+'-system').value.trim();
    if (sp) body.system_prompt = sp;
    if (document.getElementById('ti-'+i+'-json').checked) body.response_format = 'json';

    fetch(api('api/v1/jobs'), {
      method: 'POST',
      headers: authHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify(body)
    }).then(function(r) {
      var hdr = extractHeaders(r);
      return r.text().then(function(txt) {
        var highlighted;
        try { highlighted = highlightJSON(JSON.stringify(JSON.parse(txt), null, 2)); }
        catch(e) { highlighted = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        showTryitResponse(i, r.status, hdr, highlighted);
        btn.disabled = false;
        if (r.ok) loadHistory();
      });
    }).catch(function(e) {
      resp.classList.add('visible');
      bodyEl.textContent = 'Network error: ' + e.message;
      btn.disabled = false;
    });

  } else if (t === 'list-jobs') {
    const limit = document.getElementById('ti-'+i+'-limit').value || '20';
    const offset = document.getElementById('ti-'+i+'-offset').value || '0';
    fetch(api('api/v1/jobs?limit=' + limit + '&offset=' + offset), {
      headers: authHeaders()
    }).then(function(r) {
      var hdr = extractHeaders(r);
      return r.text().then(function(txt) {
        var highlighted;
        try { highlighted = highlightJSON(JSON.stringify(JSON.parse(txt), null, 2)); }
        catch(e) { highlighted = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
        showTryitResponse(i, r.status, hdr, highlighted);
        btn.disabled = false;
      });
    }).catch(function(e) {
      resp.classList.add('visible');
      bodyEl.textContent = 'Network error: ' + e.message;
      btn.disabled = false;
    });

  } else if (t === 'get-job') {
    const jobId = document.getElementById('ti-'+i+'-jobid').value.trim();
    if (!jobId) { document.getElementById('ti-'+i+'-jobid').focus(); btn.disabled = false; return; }
    fetch(api('api/v1/jobs/' + jobId), { headers: authHeaders() })
      .then(function(r) {
        var hdr = extractHeaders(r);
        return r.text().then(function(txt) {
          var highlighted;
          try { highlighted = highlightJSON(JSON.stringify(JSON.parse(txt), null, 2)); }
          catch(e) { highlighted = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
          showTryitResponse(i, r.status, hdr, highlighted);
          btn.disabled = false;
        });
      }).catch(function(e) {
        resp.classList.add('visible');
        bodyEl.textContent = 'Network error: ' + e.message;
        btn.disabled = false;
      });

  } else if (t === 'delete-job') {
    const jobId = document.getElementById('ti-'+i+'-jobid').value.trim();
    if (!jobId) { document.getElementById('ti-'+i+'-jobid').focus(); btn.disabled = false; return; }
    fetch(api('api/v1/jobs/' + jobId), { method: 'DELETE', headers: authHeaders() })
      .then(function(r) {
        var hdr = extractHeaders(r);
        return r.text().then(function(txt) {
          var body204 = r.status === 204 ? '(no content)' : (txt || '');
          showTryitResponse(i, r.status, hdr, body204.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'));
          btn.disabled = false;
          if (r.ok) loadHistory();
        });
      }).catch(function(e) {
        resp.classList.add('visible');
        bodyEl.textContent = 'Network error: ' + e.message;
        btn.disabled = false;
      });

  } else if (t === 'sse-job') {
    const jobId = document.getElementById('ti-'+i+'-jobid').value.trim();
    if (!jobId) { document.getElementById('ti-'+i+'-jobid').focus(); btn.disabled = false; return; }
    const cancelBtn = document.getElementById('ti-'+i+'-cancel');
    cancelBtn.style.display = '';
    resp.classList.add('visible');
    bodyEl.innerHTML = '';
    document.getElementById('ti-'+i+'-status-badge').innerHTML = '';
    document.getElementById('ti-'+i+'-headers').style.display = 'none';

    const ctrl = new AbortController();
    cancelBtn._abort = ctrl;
    cancelBtn.onclick = function() {
      ctrl.abort();
      cancelBtn.style.display = 'none';
      btn.disabled = false;
    };

    fetch(api('api/v1/jobs/' + jobId + '/sse'), { headers: authHeaders(), signal: ctrl.signal })
      .then(function(r) {
        document.getElementById('ti-'+i+'-status-badge').innerHTML = httpBadgeHTML(r.status);
        var hdr = extractHeaders(r);
        if (hdr) {
          var hdEl = document.getElementById('ti-'+i+'-headers');
          hdEl.textContent = hdr;
          hdEl.style.display = '';
        }
        if (!r.ok) {
          return r.text().then(function(txt) {
            bodyEl.textContent = txt || r.statusText;
            cancelBtn.style.display = 'none';
            btn.disabled = false;
          });
        }
        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        var buf = '';

        function pump() {
          reader.read().then(function(chunk) {
            if (chunk.done) { cancelBtn.style.display = 'none'; btn.disabled = false; return; }
            buf += decoder.decode(chunk.value, { stream: true });
            var parts = buf.split('\n\n');
            buf = parts.pop();
            parts.forEach(function(raw) {
              var lines = raw.split('\n');
              var eventName = '', dataStr = '';
              lines.forEach(function(line) {
                if (line.startsWith('event: ')) eventName = line.slice(7).trim();
                else if (line.startsWith('data: ')) dataStr = line.slice(6).trim();
              });
              if (!dataStr) return;
              var label = document.createElement('div');
              label.style.cssText = 'color:var(--muted);font-size:11px;margin-top:6px';
              label.textContent = 'event: ' + eventName;
              var pre = document.createElement('div');
              try { pre.innerHTML = highlightJSON(JSON.stringify(JSON.parse(dataStr), null, 2)); }
              catch(e) { pre.textContent = dataStr; }
              bodyEl.appendChild(label);
              bodyEl.appendChild(pre);
              bodyEl.scrollTop = bodyEl.scrollHeight;
            });
            pump();
          }).catch(function(e) {
            if (e.name !== 'AbortError') {
              var d = document.createElement('div');
              d.style.color = 'var(--error)';
              d.textContent = 'Stream error: ' + e.message;
              bodyEl.appendChild(d);
            }
            cancelBtn.style.display = 'none';
            btn.disabled = false;
          });
        }
        pump();
      }).catch(function(e) {
        if (e.name !== 'AbortError') { bodyEl.textContent = 'SSE error: ' + e.message; }
        cancelBtn.style.display = 'none';
        btn.disabled = false;
      });

  } else if (t === 'health') {
    fetch(api('api/v1/health'))
      .then(function(r) {
        var hdr = extractHeaders(r);
        return r.text().then(function(txt) {
          var highlighted;
          try { highlighted = highlightJSON(JSON.stringify(JSON.parse(txt), null, 2)); }
          catch(e) { highlighted = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
          showTryitResponse(i, r.status, hdr, highlighted);
          btn.disabled = false;
        });
      }).catch(function(e) {
        resp.classList.add('visible');
        bodyEl.textContent = 'Network error: ' + e.message;
        btn.disabled = false;
      });
  }
}

function buildDocs() {
  const container = document.getElementById('apiDocs');
  endpoints.forEach((ep, i) => {
    const div = document.createElement('div');
    div.className = 'endpoint';
    const mClass = 'method-' + ep.method.toLowerCase();
    const curlEscaped = ep.curl.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const respHighlighted = highlightJSON(ep.response);
    div.innerHTML =
      '<div class="endpoint-head" data-idx="'+i+'">' +
        '<span class="method '+mClass+'">'+ep.method+'</span>' +
        '<span class="path">'+ep.path+'</span>' +
        '<span class="chevron">&#9654;</span>' +
      '</div>' +
      '<div class="endpoint-body" id="epbody-'+i+'">' +
        '<div class="endpoint-desc">'+ep.desc+'</div>' +
        '<div>' +
          '<div class="code-label">curl example</div>' +
          '<div class="code-block" style="position:relative">' +
            '<button class="btn-copy" data-copy="'+i+'">Copy</button>' +
            '<code>'+curlEscaped+'</code>' +
          '</div>' +
        '</div>' +
        '<div>' +
          '<div class="code-label">example response</div>' +
          '<div class="code-block"><code>'+respHighlighted+'</code></div>' +
        '</div>' +
        buildTryitHTML(ep, i) +
      '</div>';

    div.querySelector('.endpoint-head').addEventListener('click', () => {
      const body = div.querySelector('.endpoint-body');
      const chevron = div.querySelector('.chevron');
      const open = body.classList.toggle('open');
      chevron.style.transform = open ? 'rotate(90deg)' : '';
    });

    div.querySelector('.btn-copy').addEventListener('click', async (e) => {
      e.stopPropagation();
      const idx = parseInt(e.target.dataset.copy);
      try {
        await navigator.clipboard.writeText(endpoints[idx].curl);
        e.target.textContent = 'Copied!';
        setTimeout(() => { e.target.textContent = 'Copy'; }, 1500);
      } catch {}
    });

    const tryBtn = div.querySelector('#ti-'+i+'-btn');
    if (tryBtn) {
      tryBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        tryitSend(ep, i);
      });
    }

    const latestBtn = div.querySelector('#ti-'+i+'-latest');
    if (latestBtn) {
      latestBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const id = getLatestJobId();
        if (id) document.getElementById('ti-'+i+'-jobid').value = id;
        else alert('No jobs in history yet.');
      });
    }

    container.appendChild(div);
  });
}

buildDocs();
if (apiKey) loadHistory();

// ── Splitter ──────────────────────────────────────────────────────────────────
(function() {
  var splitter = document.getElementById('splitter');
  var panelLeft = document.querySelector('.panel-left');
  var main = document.querySelector('.main');
  var dragging = false;
  var MIN_PCT = 20;

  function clamp(val, lo, hi) { return val < lo ? lo : val > hi ? hi : val; }

  function applyWidth(pct) {
    pct = clamp(pct, MIN_PCT, 100 - MIN_PCT);
    panelLeft.style.width = pct + '%';
    localStorage.setItem('cg_split_pos', pct);
  }

  // Restore saved position
  var saved = parseFloat(localStorage.getItem('cg_split_pos'));
  if (saved && saved >= MIN_PCT && saved <= 100 - MIN_PCT) {
    panelLeft.style.width = saved + '%';
  }

  function startDrag(clientX) {
    dragging = true;
    splitter.classList.add('active');
    document.body.style.userSelect = 'none';
    document.body.style.cursor = 'col-resize';
  }

  function onMove(clientX) {
    if (!dragging) return;
    var rect = main.getBoundingClientRect();
    var pct = ((clientX - rect.left) / rect.width) * 100;
    applyWidth(pct);
  }

  function stopDrag() {
    if (!dragging) return;
    dragging = false;
    splitter.classList.remove('active');
    document.body.style.userSelect = '';
    document.body.style.cursor = '';
  }

  splitter.addEventListener('mousedown', function(e) {
    e.preventDefault();
    startDrag(e.clientX);
  });

  document.addEventListener('mousemove', function(e) { onMove(e.clientX); });
  document.addEventListener('mouseup', stopDrag);

  splitter.addEventListener('touchstart', function(e) {
    e.preventDefault();
    startDrag(e.touches[0].clientX);
  }, { passive: false });

  document.addEventListener('touchmove', function(e) {
    if (dragging) { e.preventDefault(); onMove(e.touches[0].clientX); }
  }, { passive: false });

  document.addEventListener('touchend', stopDrag);
}());

})();
</script>
</body>
</html>
